<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/front/main}">

    <section layout:fragment="content">
        <form method="get" class="frmSearch" id="searchForm" onsubmit="return false" th:object="${srchParams}" autocomplete="off">
            <table class="table-cols">
                <tr>
                    <th>고객사명</th>
                    <td>
                        <input type="text" th:field="*{clntNm}" id="clntNmSrch">
                    </td>
                    <th>상품코드</th>
                    <td>
                        <input type="text" th:field="*{itemCd}" id="itemCdSrch">
                    </td>
                    <th>상품명</th>
                    <td>
                        <input type="text" th:field="*{itemNm}" id="itemNmSrch">
                    </td>
                </tr>
            </table>
            <div class="btns" align="right">
                <button class="sbtn" th:text="#{search_btn}" onclick="movePage(1)"></button>
                <button class="sbtn" th:onclick="add()" th:text="#{add_btn}"></button>
                <button class="sbtn blue" th:onclick="deleteItem()" th:text="#{delete_btn}"></button>
            </div>
        </form>
        <script>
            // 페이지이동
            function movePage(page){

                // 검색 조건을 form 에 넣어줌
                const form = document.getElementById('searchForm');

                // form 에 들어있는 검색조건을 queryParams에 넣어줌.
                const queryParams = {
                    page: (page) ? page: 1,
                    recordSize: 10,
                    pageSize: 10,
                    clntNm: form.clntNmSrch.value,
                    itemCd: form.itemCdSrch.value,
                    itemNm: form.itemNmSrch.value
                }
                // location.pathname :: 페이지의 URI를 의미함.
                // new URLSearchParams(queryParams).toString() :: queryParams 의 모든 값을 쿼리스트링으로 변환
                location.href = location.pathname + '?' + new URLSearchParams(queryParams).toString();
            }
        </script>
        <div class="table_wrapper">
            <table class="table-cols">
                <tr>
                    <th align="center">
                        <input th:type="checkbox" id="chkAll" name="chkAll">
                    </th>
                    <th>순번</th>
                    <th>물류센터명</th>
                    <th>고객사코드</th>
                    <th>고객사명</th>
                    <th>상품코드</th>
                    <th>상품명</th>
                    <th>관리단위</th>
                    <th>파렛트 당<br/>박스 수</th>
                    <th>비고</th>
                </tr>
                <tr id="id_item_table" class="itemTable" th:each="itemList : ${itemInfoList}">
                    <td align="center">
                        <input th:type="checkbox" name="chk" id="chk" th:value="${itemList.wactrCd} +','+ ${itemList.clntCd} +','+ ${itemList.LocCd} +','+ ${itemList.itemCd}">
                    </td>
                    <td align="center" th:text="${itemList.idx}"></td>
                    <td align="center" th:text="${itemList.wactrNm}"/>
                    <td align="center" th:text="${itemList.clntCd}"/>
                    <td th:text="${itemList.clntNm}"/>
                    <td th:text="${itemList.itemCd}"></td>
                    <td th:text="${itemList.itemNm}"></td>
                    <td align="center" th:text="${itemList.boxUnit}"></td>
                    <td align="center" th:text="${itemList.pltInBox}"></td>
                    <td th:text="${itemList.remk}"></td>
                </tr>
            </table>
        </div>
        <script>
            // 추가
            function add() {
                url = '/baseinfo/iteminfo/register';
                warehouse.popup.open(url, '상품정보 추가', 500, 600, true);
            };
            // 더블클릭 수정
            document.addEventListener('DOMContentLoaded', function() {
				const trs = document.querySelectorAll('tr');
				trs.forEach( (tr) => {
					tr.addEventListener('dblclick', editForm)
				});
			});

			function editForm(e) {
				console.log(e.target);
				var tr = e.target.parentNode;
				var keyVal = tr.querySelector('#chk').value.replaceAll(",", "");

				url = '/baseinfo/iteminfo/' + keyVal + '/update';
				warehouse.popup.open(url, "상품정보 수정", 500, 800, true);
			}

            document.querySelector("input[name=chk]").addEventListener("change", function (e) {
                e.preventDefault();
                var chk = document.querySelectorAll("input[name=chk]");
                chk.checked = this.checked;
                alert("chk.checked");
                if(chk.checked == true) {
                    chk.parentNode.parentNode.style.setProperty("background-color", "#D8D8D8", "important");
                }else if(chk.checked == false) {
                    chk.parentNode.parentNode.style.setProperty("background-color", "#fff", "important");
                }
            });

            // 모든 체크박스 체크
            document.querySelector("input[name=chkAll]").addEventListener("change", function (e) {
                e.preventDefault();
                var list = document.querySelectorAll("input[name=chk]");
                for (var i = 0; i < list.length; i++) {
                    list[i].checked = this.checked;
                    if(this.checked == true){
                        list[i].parentNode.parentNode.style.setProperty("background-color", "#D8D8D8", "important");
                    }else if(this.checked == false) {
                        list[i].parentNode.parentNode.style.setProperty("background-color", "#fff", "important");
                    }
                }
            });

            // 체크된 데이터 삭제
            function deleteItem(e){

                // 체크된 값 가져오기
                var checkbox = document.querySelectorAll("input[name=chk]:checked");
                var chkArr = [];
                checkbox.forEach(function (chkData){
                    chkArr.push(chkData.value.replaceAll(",", ""));
                });

                const url = `/baseinfo/iteminfo/deleteItem?chkArr=${chkArr}`;
				commonLib.ajaxLoad(url)
					.then((data) => {
						console.log(data);
						location.reload();
					})
					.catch((err) => {
						console.error(err);
					});
            }

        </script>
    </section>
</html>